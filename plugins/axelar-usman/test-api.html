<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Axelar Plugin Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .endpoint {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .endpoint h2 {
            color: #4CAF50;
            margin-top: 0;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px 10px 0;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #4CAF50;
        }
        .error {
            border-left: 4px solid #f44336;
            color: #d32f2f;
        }
        .loading {
            color: #2196F3;
        }
        .url {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            word-break: break-all;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-ok {
            background: #4CAF50;
            color: white;
        }
        .status-error {
            background: #f44336;
            color: white;
        }
        .summary {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
        }
        .summary ul {
            margin: 10px 0;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <h1>üöÄ Axelar Plugin API Test Suite</h1>
    
    <div class="summary">
        <strong>Base URL:</strong> <code>http://localhost:3015</code><br>
        <strong>Status:</strong> <span id="serverStatus">Checking...</span>
    </div>

    <!-- Test 1: Health Check -->
    <div class="endpoint">
        <h2>1. Health Check <span class="status-badge" id="health-status"></span></h2>
        <div class="url">GET http://localhost:3015/</div>
        <button class="test-button" onclick="testHealth()">üè• Test Health</button>
        <button class="test-button" onclick="openInBrowser('http://localhost:3015/')">üåê Open in Browser</button>
        <div id="health-result" class="result" style="display:none;"></div>
    </div>

    <!-- Test 2: Ping -->
    <div class="endpoint">
        <h2>2. Ping Endpoint <span class="status-badge" id="ping-status"></span></h2>
        <div class="url">GET http://localhost:3015/api/ping</div>
        <button class="test-button" onclick="testPing()">üèì Test Ping</button>
        <button class="test-button" onclick="openInBrowser('http://localhost:3015/api/ping')">üåê Open in Browser</button>
        <div id="ping-result" class="result" style="display:none;"></div>
    </div>

    <!-- Test 3: API Documentation -->
    <div class="endpoint">
        <h2>3. API Documentation <span class="status-badge" id="docs-status"></span></h2>
        <div class="url">GET http://localhost:3015/api</div>
        <button class="test-button" onclick="openInBrowser('http://localhost:3015/api')">üìñ Open Docs</button>
        <p style="color: #666; font-size: 14px;">
            Opens interactive API documentation with Swagger UI where you can test all endpoints.
        </p>
    </div>

    <!-- Test 4: Get Snapshot -->
    <div class="endpoint">
        <h2>4. Get Snapshot (Bridge Data) <span class="status-badge" id="snapshot-status"></span></h2>
        <div class="url">POST http://localhost:3015/api/snapshot</div>
        <p>Get complete snapshot of Axelar bridge data including volumes, rates, liquidity, and supported assets.</p>
        
        <strong>Test Scenarios:</strong>
        <div style="margin: 10px 0;">
            <button class="test-button" onclick="testSnapshot('simple')">üìä Simple Test (1 route, 24h)</button>
            <button class="test-button" onclick="testSnapshot('full')">üìà Full Test (Multiple windows)</button>
            <button class="test-button" onclick="testSnapshot('multi')">üîÑ Multi-Route Test</button>
        </div>
        
        <div id="snapshot-result" class="result" style="display:none;"></div>
    </div>

    <!-- Run All Tests -->
    <div class="endpoint">
        <h2>üéØ Run All Tests</h2>
        <button class="test-button" onclick="runAllTests()" style="background: #2196F3;">‚ñ∂Ô∏è Run All Tests</button>
        <button class="test-button" onclick="clearAll()" style="background: #ff9800;">üóëÔ∏è Clear Results</button>
    </div>

    <script>
        const BASE_URL = 'http://localhost:3015';

        // Check server status on load
        window.onload = () => {
            checkServerStatus();
        };

        async function checkServerStatus() {
            try {
                const response = await fetch(`${BASE_URL}/`);
                if (response.ok) {
                    document.getElementById('serverStatus').innerHTML = 
                        '<span class="status-badge status-ok">‚úì Server Running</span>';
                } else {
                    document.getElementById('serverStatus').innerHTML = 
                        '<span class="status-badge status-error">‚úó Server Error</span>';
                }
            } catch (error) {
                document.getElementById('serverStatus').innerHTML = 
                    '<span class="status-badge status-error">‚úó Server Offline</span>' +
                    '<br><small style="color: #d32f2f;">Make sure to run: cd plugins/axelar-usman && bun run dev</small>';
            }
        }

        function openInBrowser(url) {
            window.open(url, '_blank');
        }

        async function testHealth() {
            const resultDiv = document.getElementById('health-result');
            const statusBadge = document.getElementById('health-status');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = '‚è≥ Testing...';

            try {
                const response = await fetch(`${BASE_URL}/`);
                const data = await response.json();
                
                resultDiv.className = 'result success';
                statusBadge.className = 'status-badge status-ok';
                statusBadge.textContent = '‚úì OK';
                resultDiv.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                statusBadge.className = 'status-badge status-error';
                statusBadge.textContent = '‚úó Error';
                resultDiv.textContent = `Error: ${error.message}`;
            }
        }

        async function testPing() {
            const resultDiv = document.getElementById('ping-result');
            const statusBadge = document.getElementById('ping-status');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';
            resultDiv.textContent = '‚è≥ Pinging...';

            try {
                const response = await fetch(`${BASE_URL}/api/ping`);
                const data = await response.json();
                
                resultDiv.className = 'result success';
                statusBadge.className = 'status-badge status-ok';
                statusBadge.textContent = '‚úì OK';
                resultDiv.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                statusBadge.className = 'status-badge status-error';
                statusBadge.textContent = '‚úó Error';
                resultDiv.textContent = `Error: ${error.message}`;
            }
        }

        async function testSnapshot(type) {
            const resultDiv = document.getElementById('snapshot-result');
            const statusBadge = document.getElementById('snapshot-status');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result loading';

            const route1 = {
                source: {
                    chainId: "1",
                    assetId: "0xA0b86a33E6442e082877a094f204b01BF645Fe0",
                    symbol: "USDC",
                    decimals: 6
                },
                destination: {
                    chainId: "137",
                    assetId: "0x2791Bca1f2de4661ED88A30C99A7a9449Aa8417",
                    symbol: "USDC",
                    decimals: 6
                }
            };

            const route2 = {
                source: {
                    chainId: "42161",
                    assetId: "0xFF970A61A04b1cA14834A43f5dE4533eBDDB5CC8",
                    symbol: "USDC",
                    decimals: 6
                },
                destination: {
                    chainId: "1",
                    assetId: "0xA0b86a33E6442e082877a094f204b01BF645Fe0",
                    symbol: "USDC",
                    decimals: 6
                }
            };

            let params;
            if (type === 'simple') {
                resultDiv.textContent = '‚è≥ Fetching simple snapshot (1 route, 1 notional, 24h)...';
                params = {
                    routes: [route1],
                    notionals: ["1000000"],
                    includeWindows: ["24h"]
                };
            } else if (type === 'full') {
                resultDiv.textContent = '‚è≥ Fetching full snapshot (1 route, 2 notionals, all windows)...';
                params = {
                    routes: [route1],
                    notionals: ["1000000", "10000000"],
                    includeWindows: ["24h", "7d", "30d"]
                };
            } else if (type === 'multi') {
                resultDiv.textContent = '‚è≥ Fetching multi-route snapshot (2 routes, 1 notional)...';
                params = {
                    routes: [route1, route2],
                    notionals: ["1000000"],
                    includeWindows: ["24h"]
                };
            }

            try {
                // Use POST method with JSON body
                const response = await fetch(`${BASE_URL}/api/snapshot`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });
                const data = await response.json();
                
                if (response.ok && data.volumes) {
                    resultDiv.className = 'result success';
                    statusBadge.className = 'status-badge status-ok';
                    statusBadge.textContent = '‚úì OK';
                    
                    // Format summary
                    let summary = `‚úÖ Snapshot fetched successfully!\n\n`;
                    summary += `üìä Summary:\n`;
                    summary += `  ‚Ä¢ Volumes: ${data.volumes.length} time windows\n`;
                    if (data.rates) summary += `  ‚Ä¢ Rates: ${data.rates.length} quotes\n`;
                    if (data.liquidity) summary += `  ‚Ä¢ Liquidity: ${data.liquidity.length} routes\n`;
                    summary += `  ‚Ä¢ Listed Assets: ${data.listedAssets.assets.length} assets\n\n`;
                    
                    summary += `üí∞ Volume Data:\n`;
                    data.volumes.forEach(v => {
                        summary += `  ‚Ä¢ ${v.window}: $${v.volumeUsd.toLocaleString()}\n`;
                    });
                    
                    if (data.rates && data.rates.length > 0) {
                        summary += `\nüìà Rate Sample (first quote):\n`;
                        const rate = data.rates[0];
                        summary += `  ‚Ä¢ Amount In: ${rate.amountIn}\n`;
                        summary += `  ‚Ä¢ Amount Out: ${rate.amountOut}\n`;
                        summary += `  ‚Ä¢ Effective Rate: ${rate.effectiveRate.toFixed(6)}\n`;
                        summary += `  ‚Ä¢ Fee (USD): $${rate.totalFeesUsd.toFixed(2)}\n`;
                    }
                    
                    if (data.liquidity && data.liquidity.length > 0) {
                        summary += `\nüíß Liquidity Sample:\n`;
                        const liq = data.liquidity[0];
                        liq.thresholds.forEach(t => {
                            summary += `  ‚Ä¢ ${t.slippageBps}bps: ${t.maxAmountIn} max\n`;
                        });
                    }
                    
                    summary += `\n\nüìÑ Full Response:\n`;
                    summary += JSON.stringify(data, null, 2);
                    
                    resultDiv.textContent = summary;
                } else {
                    throw new Error(data.message || 'Unexpected response format');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                statusBadge.className = 'status-badge status-error';
                statusBadge.textContent = '‚úó Error';
                resultDiv.textContent = `Error: ${error.message}`;
            }
        }

        async function runAllTests() {
            await testHealth();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testPing();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testSnapshot('simple');
        }

        function clearAll() {
            document.querySelectorAll('.result').forEach(div => {
                div.style.display = 'none';
                div.textContent = '';
            });
            document.querySelectorAll('.status-badge').forEach(badge => {
                badge.className = 'status-badge';
                badge.textContent = '';
            });
        }
    </script>
</body>
</html>
